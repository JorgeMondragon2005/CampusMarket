<div class="orders-container">

  <div class="header-nav">
    <a routerLink="/home" class="btn-back">â† Volver al CatÃ¡logo</a>
    <h1>ğŸ“¦ Mis Pedidos</h1>
  </div>

  <div *ngIf="loading" class="loading">Cargando historial...</div>

  <!-- TABS DE NAVEGACIÃ“N -->
  <div class="tabs-container" style="display: flex; gap: 10px; margin-bottom: 20px;">
    <button (click)="switchTab('active')"
      [style.border-bottom]="activeTab === 'active' ? '3px solid #2563eb' : '3px solid transparent'"
      [style.color]="activeTab === 'active' ? '#2563eb' : '#64748b'"
      style="background: none; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; font-size: 1rem;">
      ğŸš€ Pedidos Activos
    </button>
    <button (click)="switchTab('history')"
      [style.border-bottom]="activeTab === 'history' ? '3px solid #2563eb' : '3px solid transparent'"
      [style.color]="activeTab === 'history' ? '#2563eb' : '#64748b'"
      style="background: none; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; font-size: 1rem;">
      ğŸ“œ Historial Pasado
    </button>
  </div>

  <div *ngIf="!loading && filteredOrders.length === 0" class="empty-state">
    <p>No tienes pedidos en esta secciÃ³n.</p>
    <a routerLink="/home" class="btn-shop">Ir a comprar</a>
  </div>

  <div class="orders-list" *ngIf="filteredOrders.length > 0">
    <div *ngFor="let order of filteredOrders" class="order-card">
      <div class="order-header">
        <span class="order-id">Pedido #{{ order.ID_Pedido }}</span>
        <span class="order-date">{{ order.Fecha_Entrega }}</span>
        <span class="status-badge" [ngClass]="order.Estado">{{ order.Estado }}</span>
      </div>

      <div class="order-body">

        <!-- STEPPER DE ESTADO -->
        <div class="status-stepper">
          <div class="step"
            [class.active]="order.Estado_Pedido === 'Pendiente' || order.Estado_Pedido === 'En preparacion' || order.Estado_Pedido === 'Listo' || order.Estado_Pedido === 'Entregado'">
            <div class="circle">1</div>
            <div class="label">Pendiente</div>
          </div>
          <div class="line"
            [class.active]="order.Estado_Pedido === 'En preparacion' || order.Estado_Pedido === 'Listo' || order.Estado_Pedido === 'Entregado'">
          </div>

          <div class="step"
            [class.active]="order.Estado_Pedido === 'En preparacion' || order.Estado_Pedido === 'Listo' || order.Estado_Pedido === 'Entregado'">
            <div class="circle">2</div>
            <div class="label">Preparando</div>
          </div>
          <div class="line" [class.active]="order.Estado_Pedido === 'Listo' || order.Estado_Pedido === 'Entregado'">
          </div>

          <div class="step" [class.active]="order.Estado_Pedido === 'Listo' || order.Estado_Pedido === 'Entregado'">
            <div class="circle">3</div>
            <div class="label">Listo</div>
          </div>
          <div class="line" [class.active]="order.Estado_Pedido === 'Entregado'"></div>

          <div class="step" [class.active]="order.Estado_Pedido === 'Entregado'">
            <div class="circle">4</div>
            <div class="label">Entregado</div>
          </div>
        </div>

        <!-- CÃ“DIGO QR (SOLO SI ESTÃ LISTO O EN PREPARACIÃ“N/PENDIENTE) -->
        <div class="qr-section"
          *ngIf="qrCodes[order.ID_Pedido] && order.Estado_Pedido !== 'Entregado' && order.Estado_Pedido !== 'Cancelado'"
          style="text-align: center; margin: 15px 0;">
          <p style="font-weight: bold; color: #2563eb; margin-bottom: 5px;">Muestra este cÃ³digo para recibir tu pedido:
          </p>
          <img [src]="qrCodes[order.ID_Pedido]" alt="CÃ³digo QR de Entrega"
            style="width: 150px; height: 150px; border: 2px solid #e2e8f0; border-radius: 10px; padding: 5px;">
        </div>

        <div class="info-row">
          <span>ğŸ“ Entrega:</span>
          <strong>{{ order.Lugar_Entrega || order.Nombre_Ubicacion }}</strong>
        </div>
        <div class="info-row">
          <span>â° Hora:</span>
          <strong>{{ order.Hora_Entrega }}</strong>
        </div>

        <div class="product-details">
          <h5 style="margin-top: 1rem; margin-bottom: 0.5rem; font-weight: bold;">Productos:</h5>
          <ul style="list-style: none; padding-left: 0;">
            <li *ngFor="let item of order.items"
              style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>{{ item.Nombre_Producto }} (x{{ item.Cantidad }})</span>
              <span>${{ item.Precio_Unitario * item.Cantidad }}</span>
            </li>
          </ul>
        </div>

        <!-- BOTÃ“N DE CALIFICAR (SOLO SI ENTREGADO) -->
        <div class="rate-section" *ngIf="order.Estado_Pedido === 'Entregado'"
          style="margin-top: 10px; text-align: right;">
          <button class="btn-primary" (click)="openRateModal(order)" *ngIf="!order.Calificado">
            â­ Calificar Servicio
          </button>
          <span *ngIf="order.Calificado" style="color: #16a34a; font-weight: bold;">âœ… Calificado</span>
        </div>

        <div class="info-row total-row">
          <span>Total:</span>
          <span class="total-price">${{ order.Precio_Total }}</span>
        </div>
      </div>
    </div>
  </div>

</div>