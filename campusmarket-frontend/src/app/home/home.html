<nav class="top-navbar">
  <div class="nav-logo">
    <span>MERCADITO</span> <span class="utm-green">UTM</span> ğŸ¦
  </div>

  <div class="nav-actions">
    <button class="btn-secondary theme-toggle" (click)="toggleTheme()" style="margin-right: 10px;">
      {{ currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™' }}
    </button>

    <div class="notification-btn-container" style="position: relative; margin-right: 10px;">
      <button class="btn-secondary" [routerLink]="['/notifications']">
        ğŸ””
        <span *ngIf="unreadCount > 0" class="badge-count"
          style="position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; font-weight: bold;">
          {{ unreadCount }}
        </span>
      </button>
    </div>

    <div class="cart-btn-container">
      <button class="btn-secondary" (click)="goToCart()">
        ğŸ›’ <span class="cart-count">{{ cartCount }}</span>
      </button>
    </div>

    <div class="user-menu">
      <button class="btn-secondary">
        ğŸ‘¤ Mi Cuenta â–¾
      </button>
      <div class="dropdown-content">
        <a (click)="goToProfile()">âš™ï¸ ConfiguraciÃ³n</a>
        <a [routerLink]="['/my-orders']">ğŸ“¦ Mis Pedidos</a>
        <a [routerLink]="['/favorites']">â¤ï¸ Mis Favoritos</a>
        <a [routerLink]="['/notifications']">ğŸ”” Notificaciones</a>
        <hr>
        <a (click)="logout()" class="logout-text">ğŸšª Cerrar SesiÃ³n</a>
      </div>
    </div>
  </div>
</nav>

<div class="marketplace-container">

  <!-- BANNER PRINCIPAL -->
  <section class="hero-banner">
    <div class="hero-content">
      <h1>MERCADITO <span class="stroke-text">UTM</span></h1>
      <p>Todo lo que necesitas para el cuatri, en un solo lugar.</p>
    </div>
    <div class="hero-decoration">ğŸ¦</div>
  </section>

  <div class="main-layout">

    <!-- BARRA LATERAL (FILTROS) -->
    <aside class="sidebar-filters">
      <h3>CategorÃ­as</h3>
      <ul class="category-list">
        <li *ngFor="let cat of categories" (click)="selectCategory(cat)"
          [class.active]="selectedCategory === cat.Nombre">
          <span class="icon">{{ getCategoryIcon(cat.Nombre) }}</span>
          {{ cat.Nombre }}
          <span class="arrow">â€º</span>
        </li>
      </ul>
    </aside>

    <!-- ÃREA PRINCIPAL DE PRODUCTOS -->
    <main class="products-area">

      <!-- BUSCADOR -->
      <div class="top-bar">
        <div class="search-pill">
          <i class="fa-solid fa-search">ğŸ”</i>
          <input type="text" [(ngModel)]="searchTerm" (input)="filterProducts()" placeholder="Buscar productos...">
        </div>
      </div>

      <!-- SELLER BANNER -->
      <div *ngIf="sellerName" class="seller-banner">
        <span>ğŸª EstÃ¡s viendo productos de: <strong>{{ sellerName }}</strong></span>
        <button class="btn-text-primary" (click)="clearSellerFilter()">Ver todos</button>
      </div>

      <!-- FILTROS HORIZONTALES (MÃ³vil) -->
      <div class="mobile-filters">
        <div class="chip-list">
          <button *ngFor="let cat of categories" class="chip" [class.active]="selectedCategory === cat.Nombre"
            (click)="selectCategory(cat)">
            {{ getCategoryIcon(cat.Nombre) }} {{ cat.Nombre }}
          </button>
        </div>
      </div>

      <!-- GRID DE PRODUCTOS -->
      <div class="products-grid">
        <div *ngFor="let item of filteredProducts" class="stuffus-card" [class.out-of-stock]="isOutOfStock(item)">

          <div class="card-image-bg">
            <span class="badge-vivid" *ngIf="!isOutOfStock(item)">NUEVO</span>
            <span class="badge-sold-out" *ngIf="isOutOfStock(item)">AGOTADO</span>

            <!-- IMAGEN SEGURA -->
            <img [src]="getImageUrl(item)" alt="{{ item.Nombre }}" style="cursor: pointer;"
              (click)="viewProduct(item.ID_Producto || item.id)" onerror="this.src='assets/placeholder.svg'">

          </div>

          <div class="card-info">
            <div class="info-top">
              <span class="category-tag">{{ item.Categoria_Nombre || 'General' }}</span>
              <h3 class="title">{{ item.Nombre || item.name }}</h3>
              <div class="rating">â­ {{ (item.Promedio_Calificacion || 0) | number:'1.1-1' }}</div>
            </div>

            <div class="info-bottom">
              <span class="price">${{ item.Precio || item.price }}</span>

              <div class="action-buttons">
                <!-- BOTÃ“N VER -->
                <button class="btn-secondary" (click)="viewProduct(item.ID_Producto || item.id)">Ver</button>

                <!-- BOTÃ“N COMPRAR (CARRITO) -->
                <button class="btn-primary" (click)="addToCart(item)" [disabled]="isOutOfStock(item)">
                  {{ isOutOfStock(item) ? 'Agotado' : 'Comprar' }}
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- MENSAJE SI NO HAY RESULTADOS -->
      <div *ngIf="filteredProducts.length === 0" class="no-results">
        <p>ğŸ˜” No encontramos productos con esa bÃºsqueda...</p>
      </div>

    </main>

  </div>
</div>