<!-- BOTÃ“N DE REGRESO -->
<div class="back-nav">
  <a routerLink="/home" class="btn-back">
    â† Volver al CatÃ¡logo
  </a>
</div>

<div class="detail-container" *ngIf="!loading && product; else loader">

  <!-- COLUMNA IZQUIERDA: IMAGEN -->
  <div class="product-image">
    <img [src]="product.Imagen_URL ? 'http://localhost:3000/uploads/' + product.Imagen_URL : 'assets/placeholder.png'"
      class="main-img" alt="{{ product.Nombre }}" onerror="this.src='https://placehold.co/600x600?text=Sin+Foto'">
  </div>

  <!-- COLUMNA DERECHA: INFORMACIÃ“N -->
  <div class="product-info">
    <span class="category-tag">{{ product.Categoria_Nombre || 'General' }}</span>

    <h1 style="display: flex; align-items: center; justify-content: space-between;">
      {{ product.Nombre }}
      <button (click)="toggleFavorite()" [style.color]="isFavorite ? '#ef4444' : '#64748b'"
        style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s;"
        [style.transform]="isFavorite ? 'scale(1.1)' : 'scale(1)'">
        {{ isFavorite ? 'â¤ï¸' : 'ğŸ¤' }}
      </button>
    </h1>

    <!-- CALIFICACIÃ“N PROMEDIO -->
    <div class="rating-display" style="margin-bottom: 15px; font-size: 1.1rem; color: #f59e0b;">
      <span class="stars-avg">â­ {{ (averageRating | number:'1.1-1') || '0.0' }}</span>
      <span class="votes-count" style="color: #64748b; font-size: 0.9rem; margin-left: 5px;">({{ totalVotes }}
        votos)</span>
    </div>

    <!-- SECCIÃ“N VENDEDOR (RESTORED & FIXED) -->
    <div class="seller-info">
      <span class="icon">ğŸª</span>
      <span>Vendido por:
        <a [routerLink]="['/home']" [queryParams]="{sellerId: product.ID_Vendedor}" class="seller-link">
          <strong>{{ product.Nombre_Tienda || 'Vendedor UTM' }}</strong>
        </a>
      </span>
    </div>

    <p class="price">${{ product.Precio }}</p>

    <div class="description">
      <h3>DescripciÃ³n</h3>
      <p>{{ product.Descripcion }}</p>
    </div>

    <!-- LUGARES DE ENCUENTRO -->
    <div class="meeting-places" *ngIf="locations.length > 0"
      style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
      <h3 style="margin-top: 0; font-size: 1rem; color: #334155;">ğŸ“ Lugares de Encuentro</h3>
      <ul style="padding-left: 20px; margin-bottom: 0; color: #475569;">
        <li *ngFor="let loc of locations" style="margin-bottom: 5px;">
          <strong>{{ loc.Nombre }}</strong> <span *ngIf="loc.Descripcion">- {{ loc.Descripcion }}</span>
        </li>
      </ul>
    </div>

    <!-- INDICADOR DE STOCK -->
    <div class="stock-badge" [class.out]="currentStock == 0" style="margin-top: 20px;">
      {{ currentStock > 0 ? 'ğŸŸ¢ Disponible: ' + currentStock + ' unidades' : 'ğŸ”´ Agotado' }}
    </div>

    <!-- BOTONES DE ACCIÃ“N -->
    <div class="actions" style="margin-top: 20px;">
      <button class="btn-add" (click)="addToCart()" [disabled]="currentStock == 0">
        ğŸ›ï¸ Agregar a mi Pedido
      </button>
    </div>

    <!-- SECCIÃ“N PARA CALIFICAR -->
    <div class="rate-product-section"
      style="margin-top: 30px; padding: 20px; background: #fffbeb; border-radius: 12px; border: 1px solid #fcd34d;">
      <h4 style="margin-top: 0; color: #92400e; margin-bottom: 10px;">Â¿QuÃ© te pareciÃ³ este producto?</h4>

      <textarea [(ngModel)]="comment" placeholder="Escribe un comentario opcional..."
        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #fcd34d; margin-bottom: 10px; font-family: inherit; resize: vertical; min-height: 60px;"></textarea>

      <div class="interactive-stars" style="font-size: 2rem; cursor: pointer; display: flex; gap: 5px;"
        (mouseleave)="clearHover()">
        <span *ngFor="let star of [1,2,3,4,5]" (click)="rate(star)" (mouseenter)="setHover(star)"
          [style.color]="star <= (hoverRating || userRating) ? '#f59e0b' : '#d1d5db'"
          style="transition: color 0.1s; transform: scale(1);">
          â˜…
        </span>
      </div>
      <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: #b45309;">Toca una estrella para calificar y enviar</p>
    </div>

    <!-- COMENTARIOS DE OTROS USUARIOS -->
    <div class="reviews-section" style="margin-top: 40px; border-top: 1px solid #e2e8f0; padding-top: 30px;">
      <h3 style="color: #334155; margin-bottom: 20px;">ğŸ’¬ ReseÃ±as de otros compradores</h3>

      <div *ngIf="reviews.length === 0"
        style="text-align: center; padding: 20px; color: #94a3b8; background: #f8fafc; border-radius: 10px;">
        AÃºn no hay comentarios para este producto.
      </div>

      <div *ngFor="let r of reviews"
        style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <strong style="color: #1e293b;">{{ r.Nombre }} {{ r.Apellido_Paterno }}</strong>
          <span style="color: #f59e0b; font-size: 0.9rem;">{{ 'â˜…'.repeat(r.Puntuacion) }}{{ 'â˜†'.repeat(5 - r.Puntuacion)
            }}</span>
        </div>
        <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px;">{{ r.Fecha | date:'mediumDate' }}</div>
        <p style="margin: 0; color: #475569; line-height: 1.5;">{{ r.Comentario }}</p>
      </div>
    </div>

  </div> <!-- Cierre de product-info -->

</div> <!-- Cierre de detail-container -->

<!-- LOADER MIENTRAS CARGA -->
<ng-template #loader>
  <div style="text-align: center; padding: 100px; font-size: 1.5rem; color: #94a3b8;">
    Cargando producto... ğŸ”
  </div>
</ng-template>